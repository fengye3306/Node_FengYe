# 滤波与卷积

## **预备知识**

* *滤波器（filter）* **本质就是图像学算法**，但并不是所有图像学算法都叫*filter*，滤波器通常指的是与卷积操作相关的算法。  
* *卷积（Convolution）* 卷积是一种数学运算，本质在于**函数（或矩阵）与另一个函数进行组合来生成新的函数，从而提取输入数据的某种特征。**   
* *卷积核（Convolution Kernel）* 如果有人提起*卷积核*，其实他就是在说*滤波器*，也就是说他在说一种基于卷积的图像学算法。这种算法通常可以用数组来可视化的表达(如下图)。  

![卷积核](./image/FilteringAndConvolution/01.png ':size=WIDTHxHEIGHT')

* *卷积核的锚点* （如上图）可以看见每个核都有一个点的值加粗显示，这个点就被称为"核的锚点"。 **这种锚点定义了核与图像的对齐关系**。

* *线性核、非线性核*  
    线性操作是指满足**叠加性（加法封闭性）和齐次性（数乘封闭性）**两个性质的操作。这意味着，线性操作在数学上可以用**线性方程来描述**。核通常为*线性核*，对于非线性核例如阈值化，以阈值进行分割产出前景与背景就是典型的非线性。

### 边界外推和边界处理

OpenCV对于卷积产生的边界问题时，给出的答案是：*边界外推*，即添加虚幻边界，使得这个虚幻边界用于卷积问题。      

```cpp
void cv::copyMakeBorder(
    cv::InputArray src,       // 源图像
    cv::OutputArray dst,      // 输出图像
    int top,                  // 上边缘填充尺寸
    int bottom,               // 下边缘填充尺寸
    int left,                 // 左边缘填充尺寸
    int right,                // 右边缘填充尺寸
    int borderType,           // 填充方式
    const cv::Scalar& value = cv::Scalar() // 常数填充值（用于某些填充方式）
);
```

> 填充方式与分析

1. cv::BORDER_CONSTANT    
    **描述：**用指定的常数值对边界进行填充。    
    **应用场景：**需要在图像周围添加固定颜色边框时使用，例如对图像进行背景色扩展。    
    **优点：**可以明确控制填充区域的颜色。    
    **缺点：**容易导致图像边缘与填充区域之间产生明显的过渡。    

2. cv::BORDER_REPLICATE  
    **描述：**复制边缘像素到扩展区域。  
    **应用场景：**用于卷积运算时需要保留边缘信息，避免边缘失真。  
    **优点：**能保持图像边缘的纹理特征，不引入新的颜色。  
    **缺点：**可能在边缘产生拉伸效果，导致边缘特征重复。  

3. cv::BORDER_REFLECT  
    **描述：**对称反射填充，不包含边缘像素，即边缘内的像素反射填充。  
    **应用场景：**需要边缘特征的平滑延续，适合图像卷积和滤波处理。  
    **优点：**保持了边缘的连续性，适合梯度计算。  
    **缺点：**不适用于所有图像，某些情况下可能会产生对称性伪影。  

4. cv::BORDER_WRAP  
    **描述：**环绕填充，使用图像的另一边的像素填充。  
    **应用场景：**用于需要周期性重复特性的图像处理。  
    **优点：**可以保持图像的周期性特征。  
    **缺点：**不常用，且可能引入不自然的边缘效果。  

5. cv::BORDER_REFLECT_101 或 cv::BORDER_DEFAULT  
    **描述：**对称反射填充，包含边缘像素（即中间对称反射）。  
    **应用场景：**同 cv::BORDER_REFLECT，适合图像卷积和滤波。  
    **优点：**较好的边缘平滑过渡。  
    **缺点：**与 cv::BORDER_REFLECT 相比，差异在于包含边缘像素。  

6. cv::BORDER_TRANSPARENT  
    **描述：**透明填充（通常为不常用的值）。  
    **应用场景：**一般没有实际意义的填充方式，在 OpenCV 中较少使用。  
    **优点：**无。  
    **缺点：**由于透明度的概念在许多图像处理中无效，此填充方式的使用受限。  

7. cv::BORDER_ISOLATED  
    **描述：**处理图像外部的边缘时忽略（不应用填充）。   
    **应用场景：**在某些需要特殊处理的场合，比如独立处理图像块时。  
    **优点：**对图像本身不做边界改变，适合独立块处理。  
    **缺点：**不改变边界，因此不适合需要扩展边界的操作。  



## **阈值化操作**

阈值化是*非线性核*，其对`1*1`大小的核进行卷积处理，**阈值化操作本质在于锚点根据相较于阈值的高低做出相应处理**。     
计算机视觉领域，很多方法都可以解释为一系列卷积运算，最后一次操作通常是阈值化处理     

```cpp
double cv::threshold( 
    InputArray _src,        // 输入矩阵
    OutputArray _dst,       // 输出矩阵
    double thresh,          // 阈值
    double maxval,          // 阈值
    int type                // 阈值化卷积核接口调用枚举标志
    )
```

> OpenCV阈值化卷积核接口调用枚举标志 参数标识

```
/** Threshold types */
enum
{
    /** 
    描述：将图像中的像素值与阈值进行比较，如果像素值大于阈值，则设置为 maxval，否则设置为 0。   
    效果：得到一个二值图像。 
    */
    CV_THRESH_BINARY      =0,  /**< value = value > threshold ? max_value : 0       */

    /** 
    描述：与 THRESH_BINARY 相反。如果像素值大于阈值，则设置为 0，否则设置为 maxval。     
    效果：得到一个反转的二值图像。
    */
    CV_THRESH_BINARY_INV  =1,  /**< value = value > threshold ? 0 : max_value       */

    /** 
    描述：将像素值与阈值进行比较。如果像素值大于阈值，则将其截断为阈值（即设置为阈值），否则不变。      
    效果：像素值高于阈值的部分被截断到阈值。  
    */
    CV_THRESH_TRUNC       =2,  /**< value = value > threshold ? threshold : value   */

    /** 
    描述：如果像素值大于阈值，则保持原值；否则将其设置为 0。      
    效果：像素值低于阈值的部分被置为 0，其他部分保持不变。  
    */
    CV_THRESH_TOZERO      =3,  /**< value = value > threshold ? value : 0           */

    /** 
    描述：与 THRESH_TOZERO 相反。如果像素值大于阈值，则保持原值；否则将其设置为 maxval。     
    效果：像素值低于阈值的部分被设置为 maxval，其他部分保持不变。
    */
    CV_THRESH_TOZERO_INV  =4,  /**< value = value > threshold ? 0 : value           */

    /** 
    描述：掩码  
    效果：其实你不用关注这个枚举值，这是OpenCV在源码中用于分割枚举阈值的 掩码位
        在源码中OpenCV通过 type &= THRESH_MASK;  相当于 0000 1111 & 0000 0111 = 0000 0111
        用于筛选和提取阈值处理方式的标志位。由于阈值处理方式的标志位在 type 的低三位中，
        所以掩码只需要保留这三位的信息。
        其他的位（如自动阈值计算方法的标志位）会被清除，从而只保留与阈值处理方式相关的标志位。
    */
    CV_THRESH_MASK        =7,

    /** 
    描述：使用 OTSU 方法自动确定阈值。这个方法在图像中自动找到最佳阈值来分割前景和背景。   
    效果：自动选择阈值进行二值化处理。 
    */
    CV_THRESH_OTSU        =8, /**< use Otsu algorithm to choose the optimal threshold value;
                               combine the flag with one of the above CV_THRESH_* values */
    /** 
    描述：使用 TRIANGLE 方法自动确定阈值。这个方法也是一种自动阈值选择算法，基于直方图。  
    效果：自动选择阈值进行二值化处理。
    */                            
    CV_THRESH_TRIANGLE    =16  /**< use Triangle algorithm to 
                                    choose the optimal threshold value;
                                    combine the flag with one of the above 
                                    CV_THRESH_* values, but not
                                     with CV_THRESH_OTSU */
};
```

### Otsu算法



### 自适应阈值

















## **平滑**

### 简单模糊和方框型滤波器

### 中值滤波器

### 高斯滤波器

### 双边滤波器

## **导数和梯度**

### 索贝尔导数

### Scharr滤波器

### 拉普拉斯变换

## **图像形态学**

### 膨胀和腐蚀

### 通用形态学函数

### 开操作和闭操作

### 形态学梯度

### 顶帽和黑帽

### 自定义核


## **用任意线性滤波器做卷积**

### 用cv::filter2D进行卷积

### 通过cv::sepFilter2D使用可分核

### 生成卷积核

## **总结**

